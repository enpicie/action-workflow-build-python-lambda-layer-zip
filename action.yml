name: 'Build Lambda Layer Zip and Upload to S3'
description: 'Installs dependencies from requirements.txt, zips for Lambda Layer, and uploads to S3.'

inputs:
  requirements_path:
    description: 'Path to requirements.txt file'
    required: true
  app_name:
    description: 'Name of application (used in .zip name)'
    required: true
  python_runtime:
    description: 'Python runtime version Layers are built for (e.g., 3.11)'
    required: true
  s3_layer_bucket_name:
    description: 'Name of the S3 bucket to upload the ZIP file to'
    required: false
    default: 'lambda.layer.python3'
  aws_region:
    description: 'AWS region for S3 bucket'
    required: false
    default: 'us-east-2'
  aws_role_arn:
    description: 'ARN of AWS IAM role to assume for S3 access'
    required: true

outputs:
  zip_file_name:
    description: 'Final ZIP file name including .zip extension'
    value: ${{ steps.set-zip-and-s3.outputs.zip_file_name }}
  s3_artifact_key:
    description: 'Full S3 key for the uploaded ZIP artifact'
    value: ${{ steps.set-zip-and-s3.outputs.s3_artifact_key }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check if requirements.txt changed
      id: check-requirements
      run: |
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^requirements.txt'; then
          echo "REQUIREMENTS_CHANGED=true" >> $GITHUB_ENV
        else
          echo "REQUIREMENTS_CHANGED=false" >> $GITHUB_ENV
        fi

    - name: Generate ZIP file name and S3 key
      id: set-zip-and-s3
      shell: bash
      run: |
        runtime_sanitized=$(echo "${{ inputs.python_runtime }}" | tr -d '.')
        zip_file="${{ inputs.app_name }}-${runtime_sanitized}.zip"
        echo "ZIP_FILE_NAME=$zip_file" >> $GITHUB_ENV
        echo "zip_file_name=$zip_file" >> $GITHUB_OUTPUT

        s3_key="applayers/$zip_file"
        echo "S3_KEY=$s3_key" >> $GITHUB_ENV
        echo "s3_artifact_key=$s3_key" >> $GITHUB_OUTPUT

    # Remaining steps only run if requirements.txt changed
    - name: Prepare build directory
      if: env.REQUIREMENTS_CHANGED == 'true'
      shell: bash
      run: |
        rm -rf layer filtered.txt
        mkdir -p layer/python
        # Filter out architecture-dependent dependencies like pynacl
        grep -v -i "^pynacl" "${{ inputs.requirements_path }}" > filtered.txt

    - name: Install pure-Python dependencies inside Lambda runtime container
      if: env.REQUIREMENTS_CHANGED == 'true'
      shell: bash
      run: |
        docker run --rm \
          -v "$PWD":/app -w /app \
          --user $(id -u):$(id -g) \
          python:${{ inputs.python_runtime }}-slim \
          pip install -r filtered.txt -t layer/python

    - name: Zip dependencies
      if: env.REQUIREMENTS_CHANGED == 'true'
      shell: bash
      run: |
        cd layer && zip -r "../$ZIP_FILE_NAME" python && cd ..

    - name: Configure AWS credentials (OIDC + role assumption)
      if: env.REQUIREMENTS_CHANGED == 'true'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.aws_role_arn }}
        aws-region: ${{ inputs.aws_region }}

    - name: Upload to S3
      if: env.REQUIREMENTS_CHANGED == 'true'
      shell: bash
      run: |
        aws s3 cp "$ZIP_FILE_NAME" "s3://${{ inputs.s3_layer_bucket_name }}/$S3_KEY"
